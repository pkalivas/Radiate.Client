@using Radiate.Client.Services.Runners
@using Radiate.Engines.Schema
@using SixLabors.ImageSharp
@using SixLabors.ImageSharp.PixelFormats
@using Color = MudBlazor.Color
@using Image = SixLabors.ImageSharp.Image
@using Size = MudBlazor.Size
@using Radiate.Client.Components.Store.Models
@using Dispatcher = Akka.Dispatch.Dispatcher
@using Radiate.Client.Components.Store.Interfaces
@using Radiate.Client.Components.Store.States.Features
@using SixLabors.ImageSharp.Drawing
@inherits StateComponent<EngineControl, RunState>
@inject IWorkItemQueue WorkItemQueue
@inject EngineRunnerFactory Runner

@if (State.IsRunning)
{
    <MudButton Class="w-100"
               Size="Size.Small"
               Variant="Variant.Filled"
               Color="Color.Secondary"
               OnClick="@Stop">
        Stop
    </MudButton>
}
else
{
    <MudButton Size="Size.Small" Color="Color.Tertiary" Variant="Variant.Filled" Class="float-right" OnClick="@Start">
        <MudIcon Icon="@Icons.Material.Filled.PlayArrow" Class="ml-0 mr-2" Size="Size.Small"/>
        Run
    </MudButton>
    @* <MudButton Class="w-100" *@
    @*            Size="Size.Small" *@
    @*            Variant="Variant.Filled" *@
    @*            Color="Color.Tertiary" *@
    @*            OnClick="@Start"> *@
    @*     Start *@
    @* </MudButton> *@
}

@code {

    private CancellationTokenSource _cancellationToken;


    private void Start()
    {
        Dispatcher.Dispatch<StartEngineAction, RootFeature>(new StartEngineAction(State.RunId));
    }

    private void Stop()
    {
        Dispatcher.Dispatch<CancelEngineRunAction, RootFeature>(new CancelEngineRunAction(State.RunId));
        // _cancellationToken.Cancel();
        // Dispatch(new FunctionalAction(state => state.Running = false));
    }
    
    // private void OnResultCreated(EngineOutputState output) => 
    //     InvokeAsync(() =>
    //     {
    //         Dispatch(new FunctionalAction(state => state.EngineOutputs = output));
    //         Dispatch(state => state.Scores.Add(output.Metrics.Get(MetricNames.Score).Statistics.LastValue));
    //         
    //         if (output.Outputs.Any(val => val.Name == "Image"))
    //         {
    //             var image = output.GetOutputValue<string>("Image");
    //             Dispatch(state => state.ImageState.Current = new ImageEntity
    //             {
    //                 ImageData = Image.Load<Rgba32>(Convert.FromBase64String(image)),
    //             });
    //         }
    //
    //         if (output.EngineState is EngineStateTypes.Stopped)
    //         {
    //             Dispatch(state => state.Running = false);
    //         }
    //     });
}