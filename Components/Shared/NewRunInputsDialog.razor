@using Radiate.Client.Services.Store.Schema

<MudDialog>
    <DialogContent>
        <div class="row">
            <div class="col">
                <div>
                    <MudSelect SelectedValuesChanged="@OnModelChange"
                               Value="@RunModel.Inputs.ModelType"
                               MultiSelection="false"
                               HelperText="Model To Run"
                               T="string"
                               Label="Model"
                               Variant="Variant.Text">
                        @foreach (var model in StateOptions.ModelNames)
                        {
                            <MudSelectItem Value="@model"/>
                        }
                    </MudSelect>
                </div>
                <div>
                    <MudSelect SelectedValuesChanged="@OnDataSetChange"
                               Value="@RunModel.Inputs.DataSetType"
                               MultiSelection="false"
                               HelperText="DataSet To Run"
                               T="string"
                               Label="DataSet"
                               Variant="Variant.Text">
                        @if (RunModel.Inputs.ModelType == "Image")
                        {
                            @foreach (var data in StateOptions.ImageDataSetNames)
                            {
                                <MudSelectItem Value="@data"/>
                            }
                        }
                        else
                        {
                            @foreach (var data in StateOptions.DataSetNames)
                            {
                                <MudSelectItem Value="@data"/>
                            }
                        }
                    </MudSelect>
                </div>
                <div class="mt-3">
                    <h5>Genetic Inputs</h5>
                    <MudDivider/>
                    <div class="row">
                        <div class="col">
                            <MudNumericField Label="Population Size"
                                             Variant="Variant.Filled"
                                             Value="@RunModel.Inputs.PopulationInputs.PopulationSize"
                                             ValueChanged="@((int size) => RunModel.Inputs.PopulationInputs.PopulationSize = size)">
                            </MudNumericField>
                            <MudNumericField Label="Mutation Rate"
                                             Variant="Variant.Filled"
                                             Value="@RunModel.Inputs.PopulationInputs.MutationRate"
                                             ValueChanged="@((float rate) => RunModel.Inputs.PopulationInputs.MutationRate = rate)">
                            </MudNumericField>
                            <MudNumericField Label="Max Epochs"
                                             Variant="Variant.Filled"
                                             Value="@RunModel.Inputs.LimitInputs.IterationLimit"
                                             ValueChanged="@((int limit) => RunModel.Inputs.LimitInputs.IterationLimit = limit)">
                            </MudNumericField>
                        </div>
                        @if (RunModel.Inputs.ModelType == "Image")
                        {
                            <div class="col">
                                <MudNumericField Label="Num Shapes"
                                                 Variant="Variant.Filled"
                                                 Value="@RunModel.Inputs.ImageInputs.NumShapes"
                                                 ValueChanged="@((int limit) => RunModel.Inputs.ImageInputs.NumShapes = limit)">
                                </MudNumericField>
                                @if (RunModel.Inputs.DataSetType == "Polygon")
                                {
                                    <MudNumericField Label="Num Vertices"
                                                     Variant="Variant.Filled"
                                                     Value="@RunModel.Inputs.ImageInputs.NumVertices"
                                                     ValueChanged="@((int limit) => RunModel.Inputs.ImageInputs.NumVertices = limit)">
                                    </MudNumericField>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>
            @if (RunModel.Inputs.ModelType == "Image")
            {
                <div class="col">
                    <div class="mt-3">
                        <h5>Image Inputs</h5>
                        <MudDivider/>
                    </div>
                    <div class="row mb-2 mt-3">
                        <div class="col-9">
                             <ImageDisplay ImageTitle="Upload"
                                            ImageUrl="@RunModel.Inputs.ImageInputs.TargetImage.ImageDisplay"/>
                        </div>
                        <div class="col-3">
                            <ImageUpload Height="@RunModel.Inputs.ImageInputs.Height"
                                         Width="@RunModel.Inputs.ImageInputs.Width"
                                         ImageChanged="@TargetImageChanged"/>
                        </div>
                    </div>
                </div>
            }
        </div>

        <MudDivider/>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" OnClick="Submit">Start</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; }
    
    private RunModel RunModel { get; set; }

    protected override void OnInitialized()
    {
        RunModel = new RunModel();
        base.OnInitialized();
    }

    void Cancel() => MudDialog.Cancel();

    void Submit() => MudDialog.Close(DialogResult.Ok(RunModel)); 

    private void OnModelChange(IEnumerable<string> model)
    {
        var selectedModel = model.First();
        if (RunModel.Inputs.ModelType == "Image" && selectedModel != "Image")
        {
	        RunModel.Inputs.DataSetType = "Graph";
        }

        RunModel.Inputs.ModelType = model.First();
        if (RunModel.Inputs.ModelType == "Image")
        {
	        RunModel.Inputs.DataSetType = "Polygon";
        }
    }
    
    private void OnDataSetChange(IEnumerable<string> value)
    {
        RunModel.Inputs.DataSetType = value.First();
    }

    private void TargetImageChanged(ImageEntity image)
    {
        RunModel.Inputs.ImageInputs.TargetImage = image;
    }
}