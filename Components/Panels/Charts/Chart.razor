@using Radiate.Engines.Entities
@using Plotly.Blazor.Traces.ScatterLib
@using Margin = Plotly.Blazor.LayoutLib.Margin
@using Plotly.Blazor.LayoutLib
@using Plotly.Blazor.LayoutLib.XAxisLib
@using Radiate.Client.Services.Schema

@if ((Values.Any() || ValuesList.Any()) && Type != "" && layout != null)
{
    <PlotlyChart @bind-Config="config" @bind-Layout="layout" @bind-Data="data" @ref="chart"/>
}

@code {
    [Parameter] public int Height { get; set; } = 200;
    [Parameter] public string Type { get; set; } = "";
    [Parameter] public bool ShowGrid { get; set; } = false;
    [Parameter] public double[] Values { get; set; } = Array.Empty<double>();
    [Parameter] public List<double[]> ValuesList { get; set; } = new();

    private PlotlyChart chart;
    private Config config = new() { Responsive = true};

    private Layout? layout;

    private IList<ITrace> data { get; set; }

    protected override void OnParametersSet()
    {
        layout = new()
        {
            Height = Height,
            Font = new Font
            {
                Color = "#a9a9a9"
            },
            XAxis = new List<XAxis>
            {
                new()
                {
                    ShowGrid = ShowGrid,
                    ShowLine = ShowGrid,
                    GridColor = ShowGrid ? "#a9a9a9" : "#000000"
                }
            },
            YAxis = new List<YAxis>
            {
                new()
                {
                    ShowGrid = ShowGrid,
                    ShowLine = ShowGrid,
                    GridColor = ShowGrid ? "#a9a9a9" : "#000000"
                }
            },
            PaperBgColor = "rgba(0,0,0,0)",
            PlotBgColor = "rgba(0,0,0,0)",
            Margin = new Margin
            {
                T = 1,
                B = 20,
                L = 35,
                R = 1
            },
        };
        
        if ((Values.Any() || ValuesList.Any()) && Type != "")
        {
            data = Type switch
            {
                ChartTypes.Bar => [GetBarTrace()],
                ChartTypes.Pie => [GetPieTrace()],
                ChartTypes.Front => [GetScatter3D()],
                _ => [GetScatter()],
            };
            
            chart?.Update();
        }
        
        if (Height != layout.Height)
        {
            layout.Height = Height;
            StateHasChanged();
        }
        
        base.OnParametersSet();
    }

    private Scatter GetScatter() => new()
    {
        Name = "ScatterTrace",
        Mode = ModeFlag.Lines,
        Y = Values.Select(val => (object) val).ToList(),
        X = Values.Select((_, idx) => (object) idx).ToList(),
    };

    private Scatter3D GetScatter3D() => new()
    {
        Mode = Plotly.Blazor.Traces.Scatter3DLib.ModeFlag.Markers,
        X = ValuesList.Select(val => (object) val[0]).ToList(),
        Y = ValuesList.Select(val => (object) val[1]).ToList(),
        Z = ValuesList.Select(val => (object) val[2]).ToList(),
    };
    
    private Bar GetBarTrace()
    {
        var buckets = Values
            .GroupBy(val => val)
            .Select(group => new {Value = group.Key, Count = group.Count()})
            .OrderByDescending(group => group.Count)
            .ToList();
        
        return new Bar
        {
            Name = "BarTrace",
            X = buckets.Select(val => (object) val.Value).ToList(),
            Y = buckets.Select((val, idx) => (object) val.Count).ToList(),
        };
    }
    
    private Pie GetPieTrace()
    {
        var buckets = Values
            .GroupBy(val => val)
            .Select(group => new {Value = group.Key, Count = group.Count()})
            .OrderByDescending(group => group.Count)
            .ToList();
        
        return new Pie
        {
            Name = "PieTrace",
            Values = buckets.Select(val => (object) val.Value).ToList(),
            Labels = buckets.Select((val, idx) => (object) val.Count).ToList(),
        };
    }
}