@using Radiate.Engines.Entities
@using Radiate.Client.Services.Store.Models
@using Radiate.Client.Services.Store.Selections
@using Radiate.Client.Services.Store.Actions
@inherits StoreComponent<EngineModel>

<MudDialog>
    <DialogContent>
        
        <MudTreeView Items="@Model.TreeItems">
            <ItemTemplate>
                <MudTreeViewItem @bind-Expanded="@context.IsExpanded" Items="@context.TreeItems" OnClick="@(() => OnSelectedValueChanged(context))">
                    <Content>
                        <MudTreeViewItemToggleButton @bind-Expanded="@context.IsExpanded" Visible="@context.HasChild"/>
                        <EngineStateDisplay EngineState="@context.Data"/>
                    </Content>
                </MudTreeViewItem>
            </ItemTemplate>
        </MudTreeView>

    </DialogContent>
</MudDialog>


@code {
    
    [CascadingParameter] MudDialogInstance MudDialog { get; set; }
    
    private void OnSelectedValueChanged(TreeItemData<EngineState> context)
    {
        var data = Model.TreeItems.ToDictionary(key => key.Data.EngineId, value => value.IsExpanded);
        data[context.Data.EngineId] = !context.IsExpanded;
        Dispatch(new SetEngineTreeExpandedAction(Model.RunId, data));
    }
    
    protected override IObservable<EngineModel> Select() =>
        Store.Select(EngineSelectors.SelectEngineModel);
}