@inherits StoreComponent<EngineTreePanelProjection>

<MudTreeView Items="@Model?.TreeItems" Dense="true">
    <ItemTemplate>
        <MudTreeViewItem @bind-Expanded="@context.IsExpanded" Items="@context.TreeItems" OnClick="@(() => OnSelectedValueChanged(context))">
            <Content>
                <MudTreeViewItemToggleButton @bind-Expanded="@context.IsExpanded" Visible="@context.HasChild"/>
                <EngineStateDisplay EngineState="@context.Data"/>
            </Content>
        </MudTreeViewItem>
    </ItemTemplate>
</MudTreeView>

@code 
{
    private void OnSelectedValueChanged(TreeItemData<EngineState> context)
    {
        var data = Model.TreeItems.ToDictionary(key => key.Data.EngineId, value => value.IsExpanded);
        data[context.Data.EngineId] = !context.IsExpanded;
        Dispatch(new SetEngineTreeExpandedAction(Model.RunId, data));
    }
    
    protected override IObservable<EngineTreePanelProjection> Select() =>
        Store.Select(EngineSelectors.SelectEngineTreePanelModel);
}