@using Radiate.Engines.Entities
@using Radiate.Client.Components.Store.Models
@inherits StateComponent<EngineStateTree, EngineRunState>

<MudDialog>
    <DialogContent>
        
        <MudTreeView Items="@State.TreeItems">
            <ItemTemplate>
                <MudTreeViewItem @bind-Expanded="@context.IsExpanded" Items="@context.TreeItems" OnClick="@(() => OnSelectedValueChanged(context))">
                    <Content>
                        <MudTreeViewItemToggleButton @bind-Expanded="@context.IsExpanded" Visible="@context.HasChild"/>
                        <EngineStateDisplay EngineState="@context.Data"/>
                    </Content>
                </MudTreeViewItem>
            </ItemTemplate>
        </MudTreeView>

    </DialogContent>
</MudDialog>


@code {
    
    [CascadingParameter] MudDialogInstance MudDialog { get; set; }
    
    private void OnSelectedValueChanged(TreeItemData<EngineState> context)
    {
        var data = State.TreeItems.ToDictionary(key => key.Data.EngineId, value => value.IsExpanded);
        data[context.Data.EngineId] = !context.IsExpanded;
        Dispatch(new SetEngineTreeExpandedAction(State.RunId, data));
    }
}