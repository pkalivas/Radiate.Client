@page "/"
@rendermode InteractiveServer
@inject IDialogService DialogService
@inject NavigationManager NavigationManager
@using Radiate.Client.Services.Store.Models
@using Radiate.Client.Services.Store.Actions
@using Radiate.Client.Services.Store
@inherits StoreComponent<RootState>

<MudPaper Elevation="25" Class="mt-4 ml-4 mr-4 px-8">
    <MudToolBar>
        Engine Runs
        <MudSpacer />
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="OpenDialog">New Run</MudButton>
    </MudToolBar>
</MudPaper>
<MudTable OnRowClick="@((TableRowClickEventArgs<RunModel> args) => OnSelect(args))" Items="@Model?.Runs.Values.ToList()" Class="ml-4 mr-4 px-8">
    <HeaderContent>
        <MudTh></MudTh>
        <MudTh>Model</MudTh>
        <MudTh>Data Set</MudTh>
        <MudTh>Status</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd>@context.Index</MudTd>
        <MudTd DataLabel="Model">@context.Inputs.ModelType</MudTd>
        <MudTd DataLabel="Data Set">@context.Inputs.DataSetType</MudTd>
        <MudTd DataLabel="Status">@context.Status</MudTd>
    </RowTemplate>
</MudTable>

@code {
    
    private void OnSelect(TableRowClickEventArgs<RunModel> run)
    {
        Dispatch(new NavigateToRunAction(run.Item.RunId));
        NavigationManager.NavigateTo($"/runs/{run.Item.RunId}");
    }

    private async Task OpenDialog()
    {
        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseOnEscapeKey = true
        };

        var dialogRef = await DialogService.ShowAsync<NewRunInputsDialog>("Run Dialog", options);
        var result = await dialogRef.Result;

        if (!result.Canceled)
        {
            Dispatch(new RunCreatedAction((RunModel)result.Data));
        }
    }

    protected override IObservable<RootState> Select() => Store.Select();
}
